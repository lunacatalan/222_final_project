---
title: "Climatic Trend and Agriculture on Declining Water Levels in Arid Aquifer, Iran"
author: "Luna Herschenfeld-Catalan"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
---

# Problem

Groundwater supplies water resources for drinking water and irrigated agriculture for millions of people around the world[CITE]. Groundwater levels are declining around the world. This is partly do to changing climatic trends[CITE], where declines in precipitation is leading to declines in recharge of groundwater storage in aquifers. Over the last couple of decades, agriculture production in many areas has also increased[CITE]. In arid regions, agriculture is mainly fed by groundwater since there is not enough surface water available, or it does not rain enough.

In the last 40 years, groundwater level declines in the Qazvin Plain, in Iran have accelerated. - Why agriculture is what I am looking at: <https://www.researchgate.net/profile/Zahra-Mousavi-16/publication/339627057_Land_subsidence_from_interferometric_SAR_andgroundwater_patterns_in_the_Qazvin_plain_Iran/links/5f604a6a299bf1d43c04ed23/Land-subsidence-from-interferometric-SAR-andgroundwater-patterns-in-the-Qazvin-plain-Iran.pdf>

To determine next steps with groundwater management, it is important to understand what factors are playing key roles in this rapid decline. This analysis can help guide groundwater management strategy...

# Data

Groundwater level data is stored as an excel file as `groundwater_time_series.xlsx` from the year 1978-2018, with 2002-2003 data missing. The water level is a measurement of depth to water in (WHAT ARE THE UNITS???).

Precipitation data is stored as an excel file as `annual_precip.xlsx` from the year 1979-2022, and measures the total annual precipitation in the Qazvin Plain for each year.

To estimate the role of agriculture, I had a couple of approaches:

1\. The first was to use area equipped for irrigation from <https://zenodo.org/records/7809342>. This data can be found in the `AEI_ASC` folder.

2\. The second approach was to query landsat data and calculate the change in NDVI over the time period. These images are available beginning at 1984-2021. - The analysis of these images was conducted in Python using the Microsoft Planetary Computer - The files are stored in the `ag_density` folder

# What we want to know

Does precipitation trends or agricultural production play a greater role in groundwater level decline in the Qazvin aquifer over 1984-2018?

## Load Libraries

```{r include = TRUE, message = FALSE, warning = FALSE}
# load libraries
library(foreign)
library(tidyverse)
library(here)
library(sf)
library(terra)
library(spData)
library(geodata)
#library(spDataLarge)
library(modelr)
library(ggplot2)
library(knitr)
library(broom)
library(patchwork)
library(lubridate) # for dates
library(tsibble)
library(feasts)
```

## Read in data

### Groundwater level time series data from 1978-2018

-   Calculated the mean groundwater level per year

```{r include = TRUE, message = FALSE, warning = FALSE}
gw_level_total <- readxl::read_xlsx(here("data/groundwater_time_series.xlsx")) %>% 
  select(Year, WaterLevel) %>% # select years
  separate_wider_delim(col = Year, 
                       ".", # separate the months
           names = c("Year", "Month")) %>% 
  select(!Month) %>% # remove the decimal column 
  mutate_at(vars(Year), as.numeric)

# these are the mean depth to groundwater level
gw_mean <- gw_level_total %>% 
  group_by(Year) %>% 
  summarize(mean = mean(WaterLevel)) %>% 
  rename(year = Year)
```

### Precipitation time series data from

```{r include = TRUE, message = FALSE, warning = FALSE}
precip <- readxl::read_xlsx(here("data/annual_precip.xlsx")) %>%
  select(!StnID) # remove column
```

### Load in qazvin aquifer shapefile

```{r include = TRUE, message = FALSE, warning = FALSE}
qazvin_aquifer <- st_read(here('data/qazvin/qazvin.shp'))
```

### Read in SAVI data

### Read in the data from the Buffer zone

```{r include = TRUE, message = FALSE, warning = FALSE}
quartile_names <- c("min", "q1", "median", "q3", "max")


savi <- read_csv(here("data/ag_density/savi_buffer_quartiles.csv")) %>% 
  rename("quartiles" = "...1") %>% 
  replace("quartiles", quartile_names) %>% 
  pivot_longer(col = 2:67,
               names_to = 'date', 
               values_to = 'values') %>% 
    separate(col = 2, 
           into = "string",
           sep = "_02") %>% 
  separate_wider_delim(cols = 2, delim = "165035_", names = c("left", "date")) %>% 
  select(!left)

savi_date <- ymd(savi$date, format="%Y%m%d") 
savi_date <- savi_date[-length(savi_date)]

savi <- savi %>% 
  cbind(savi_date) %>% 
  select(quartiles,
         date = savi_date,
         values) %>% 
  filter(savi$quartiles != "min")

savi_years <- savi %>% 
  separate_wider_delim(cols = 2, 
                       delim = "-05-", 
                       names = c("year", "md")) %>% 
  select(!md) %>% 
  group_by(year, quartiles) %>% 
  summarize(val = mean(values)) %>% 
  mutate_at(vars(year), as.numeric) %>% 
  pivot_wider(names_from = quartiles,
              values_from = val)
  
```

```{r include = TRUE, message = FALSE, warning = FALSE}
ggplot() +
  geom_line(data = savi, 
            aes(x = date, 
                y = values, 
                color = quartiles))
```

### Read in the data from the aquifer zone 

```{r include = TRUE, message = FALSE, warning = FALSE}

quartile_names <- c("min_aq", "q1_aq", "median_aq", "q3_aq", "max_aq", "sum_aq")


savi_aq <- read_csv(here("data/ag_density/savi_aq_df.csv")) %>% 
  rename("quartiles" = "...1") %>% 
  replace("quartiles", quartile_names) %>% 
  pivot_longer(col = 2:66,
               names_to = 'date', 
               values_to = 'values') %>% 
    separate(col = 2, 
           into = "string",
           sep = "_02") %>% 
  separate_wider_delim(cols = 2, delim = "165035_", names = c("left", "date")) %>% 
  select(!left)

savi_date_aq <- ymd(savi_aq$date, format="%Y%m%d") 
savi_date_aq <- savi_date_aq[-length(savi_date_aq)]

savi_aq <- savi_aq %>% 
  cbind(savi_date_aq) %>% 
  select(quartiles,
         date = savi_date_aq,
         values) %>% 
  filter(savi_aq$quartiles != "min_aq")

savi_years_aq <- savi_aq %>% 
  separate_wider_delim(cols = 2, 
                       delim = "-05-", 
                       names = c("year", "md")) %>% 
  select(!md) %>% 
  group_by(year, quartiles) %>% 
  summarize(val = mean(values)) %>% 
  mutate_at(vars(year), as.numeric) %>% 
  pivot_wider(names_from = quartiles,
              values_from = val)
```

```{r include = TRUE, message = FALSE, warning = FALSE, eval = FALSE}
savi_aq <- savi_aq %>% 
  cbind(savi_date_aq) %>% 
  select(quartiles,
         date = savi_date_aq,
         values) %>% 
  filter(savi_aq$quartiles != "sum_aq")

ggplot() +
  geom_line(data = savi_aq, 
            aes(x = date, 
                y = values, 
                color = quartiles))
```

### Load in irrigation data

```{r include = TRUE, message = FALSE, warning = FALSE}
qazvin_box <- data.frame(name = c("1", "2", "3", "4"),
                         long = c(49.31937729228426, 49.31937729228426, 51.12523623049739, 51.12523623049739),
                         lat = c(36.493217304744505, 35.52665079679184, 35.52665079679184, 36.493217304744505))

qazvin_box = st_polygon(list(
  cbind(
    qazvin_box$long[c(1, 2, 3, 4, 1)],
    qazvin_box$lat[c(1, 2, 3, 4, 1)]
  )
))

# list files for each band, including the full file path
filelist <- list.files(here("data/AEI_ASC/"), # say what folder to read the files in 
                       full.names = TRUE)

# read in and store as a raster stack
asc_1900_2015 <- rast(filelist) 

# need to set crs
qazvin_box <- st_sfc(qazvin_box,
                     crs = st_crs(asc_1900_2015))

irrigation_qazvin <- asc_1900_2015 %>% 
  crop(., qazvin_box)

names(irrigation_qazvin) <- c("1900", "1910", "1920", "1930", "1940", "1950", "1960", "1970", "1980", "1985", "1990", "1995", "2000", "2005", "2010", "2015")

plot(irrigation_qazvin)
```

```{r include = TRUE, message = FALSE, warning = FALSE}
# transform shapefle to crs of irrigation map
qazvin_aquifer <- st_transform(qazvin_aquifer, 
                         crs = st_crs(irrigation_qazvin))

ir_aq <- irrigation_qazvin %>% 
  crop(., qazvin_aquifer)

plot(ir_aq)
ir_aq
```

```{r include = TRUE, message = FALSE, warning = FALSE}

ir_df <- as.data.frame(ir_aq) %>% 
  pivot_longer(1:16, 
               names_to = "year",
               values_to = "values") %>% 
  mutate_at(vars(year), as.numeric)
  

ir_summary <- ir_df %>% 
  group_by(year) %>% 
  mutate(ir_mean = mean(values),
         ir_sd = sd(values),
         ir_max = max(values),
         ir_median = median(values),
         ir_sum = sum(values)) %>% 
  select(!values) %>% 
  slice(16)

```

### Load in ndvi data

```{r include = TRUE, message = FALSE, warning = FALSE}
ndvi_percent_aquifer <- read_csv(here("data/ag_density/ndvi_percent_aquifer.csv")) %>% 
  select(year, percent) %>% 
  rename(aq_percent_ndvi = percent)

ndvi_percent_well <- read_csv(here("data/ag_density/ndvi_percent_well_df.csv")) %>% 
  select(years, percent) %>% 
  rename(well_percent_ndvi = percent)

ndvi <- ndvi_percent_aquifer %>% 
  full_join(ndvi_percent_well, by = c("year" = "years"))

ndvi_sum <- read_csv(here("data/ag_density/ndvi_sum.csv")) %>% 
  select(year, sum)
  
```

## Prepare Data to Analyze

### Join Groundwater level and precip data together

This code chunk will create a dataframe with all of the variables for each year:

```{r include = TRUE, message = FALSE, warning = FALSE}
qazvin_clean <- gw_mean %>% 
  left_join(precip, by = "year") %>% 
  left_join(ndvi, by = "year") %>% 
  left_join(ndvi_sum, by = "year") %>% 
  left_join(ir_summary, by = "year") %>% 
  left_join(savi_years, by = 'year') %>%
  left_join(savi_years_aq, by = "year") %>% 
  rename(level = mean,
         annual_precip = total_annual_precip)

```

## Run regression model

To visualize the trends run this chunk right here:

```{r include = TRUE, message = FALSE, warning = FALSE}

level_plot <- ggplot(qazvin_clean) + 
  geom_point(aes(x = year, 
            y = level))

precip_plot <- ggplot(qazvin_clean) + 
  geom_line(aes(x = year, 
            y = annual_precip))


ndvi_plot <- qazvin_clean %>% 
  pivot_longer(cols = 4:5, 
               names_to = 'ndvi_values', 
               values_to = 'values') %>% 
  ggplot() + 
  geom_point(aes(x = year, 
            y = values, 
            color = ndvi_values))
            

sum_plot <- ggplot(ndvi_sum) + 
  geom_point(aes(x = year, 
            y = sum))


max_savi <- ggplot() +
  geom_point(data = qazvin_clean, 
             aes(x = year, 
                 y = max))


# precipitation and ndvi sum do not have strong correlation
ggplot() +
  geom_point(data = qazvin_clean, 
             aes(x = sum, 
                 y = annual_precip))

ggplot() +
  geom_point(data = qazvin_clean, 
             aes(x = year, 
                 y = ir_mean))

#sum_plot + level_plot + ndvi_plot + precip_plot +
max_savi
```

```{r include = TRUE, message = FALSE, warning = FALSE}
ggplot() +
  geom_line(data = savi_years_aq, 
            aes(x = sum, 
                y = level)) +
  geom_smooth(method = "lm", # tell what to fit model to 
              formula = y ~ x, # association between variables
              se = FALSE) + #standard error
  labs(x = 'sum of SAVI values over Aquifer', 
       y = 'depth to groundwater') +
  theme_minimal()

```

## Run lm() on ndvi sum values at each location

```{r include = TRUE, message = FALSE, warning = FALSE}
# mod1 for the aquifer percent pixel cover
lm(level ~ annual_precip + aq_percent_ndvi, data = qazvin_clean) %>% 
  summary()

# mod2 for the aquifer sum --> has a statistically significant result 
lm(level ~ annual_precip + sum, data = qazvin_clean) %>% 
  summary()

# mod3 for irrigation mean
lm(level ~ annual_precip + ir_mean, data = qazvin_clean) %>% 
  summary()

# mod4 for savi
lm(level ~ q1, data = qazvin_clean) %>% 
  summary()

# mod4 for savi
lm(level ~ q1 + annual_precip, data = qazvin_clean) %>% 
  summary()

# mod4 for savi aquifer
lm(level ~ sum, data = qazvin_clean) %>% 
  summary()

```

```{r include = TRUE, message = FALSE, warning = FALSE}
ggplot(data = qazvin_clean, 
       aes(rev(x = q1), # reverse the y axis
                 y = level)) +
  geom_point() +
  geom_smooth(method = "lm", # tell what to fit model to 
              formula = y ~ x, # association between variables
              se = FALSE) + #standard error
  labs(x = '1st quartile SAVI', 
       y = 'depth to groundwater') +
  theme_minimal()

# mod4 for savi
lm(level ~ q1 + annual_precip, data = qazvin_clean) %>% 
  summary()

mod <- lm(level ~ q1 + annual_precip, data = qazvin_clean)


```

1st quartile: The SAVI level that 25% of the data falls below - When 25% of the data is below a temperature of 0 degrees, the groundwater level is 100.84m. For every 1 increase in degrees that 25% of the data falls under, the depth to groundwater increases by 423.96 m. - To make this applicable to the graph, the degrees are scaled down by a factor of 10, so that for every 0.1 degree increase in the degrees that 25% of the data falls under, the depth to groundwater increases by 42.396 m.

## Looking at the decomp of sum

```{r include = TRUE, message = FALSE, warning = FALSE}

qazvin_ts_sum <- as_tsibble(ndvi_sum, index = "year") %>% 
  filter(!is.na(sum)) %>% 
  model(classical_decomposition(sum, type = "additive")) %>% 
  components() %>% 
  autoplot()

qazvin_ts_sum

qazvin_ts_2018 <- as_tsibble(qazvin_clean, index = "Year") %>% 
  fill_gaps() %>% 
  filter(!is.na(sum)) %>% 
  filter(Year > 2003) %>% 
  model(STL(sum, type = "additive")) %>% 
  components() %>% 
  autoplot()

qazvin_ts_2001

qazvin_ts_2018
```

## Looking at the decomp of sum

```{r include = TRUE, message = FALSE, warning = FALSE}
qazvin_ts_2001 <- as_tsibble(qazvin_clean, index = "Year") %>% 
  fill_gaps() %>% 
  filter(!is.na(sum)) %>% 
  filter(Year <= 2001) %>% 
  model(STL(sum, type = "additive")) %>% 
  components() %>% 
  autoplot()

qazvin_ts_2001
```
